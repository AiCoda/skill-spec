# Skill-Spec: Detect Layer Violation
# Version: 1.0.0
# Detects cross-layer reverse dependencies in software architecture

spec_version: "skill-spec/1.0"

_meta:
  content_language: "en"
  mixed_language_strategy: "en-only"

skill:
  name: "detect-layer-violation"
  version: "1.0.0"
  purpose: "Analyze codebase to detect cross-layer reverse dependencies that violate architectural layering principles"
  owner: "architecture-team"

inputs:
  - name: source_files
    type: array
    required: true
    constraints: [not_empty]
    description: "List of source files with their content and path information"
    items:
      type: object
      properties:
        path:
          type: string
          description: "File path relative to project root"
        content:
          type: string
          description: "File content"
        language:
          type: string
          description: "Programming language"

  - name: layer_config
    type: object
    required: true
    description: "Layer definition and dependency rules"
    schema:
      type: object
      required: [layers, allowed_dependencies]
      properties:
        layers:
          type: array
          description: "Ordered list of layers from top to bottom"
          items:
            type: object
            properties:
              name:
                type: string
              patterns:
                type: array
                items:
                  type: string
                description: "Path patterns that belong to this layer"
        allowed_dependencies:
          type: object
          description: "Map of layer -> list of layers it can depend on"

  - name: ignore_patterns
    type: array
    required: false
    description: "File patterns to ignore during analysis"
    default: ["**/test/**", "**/__test__/**", "**/mock/**"]

  - name: strict_mode
    type: boolean
    required: false
    description: "If true, treats warnings as errors"
    default: false

preconditions:
  - "Source files must be parseable in their respective languages"
  - "Layer configuration must define at least 2 layers"
  - "Each layer must have at least one path pattern"

non_goals:
  - "Fix or refactor code to resolve violations"
  - "Analyze runtime dependencies or dynamic imports"
  - "Detect circular dependencies within the same layer"
  - "Validate business logic correctness"
  - "Check for unused imports or dead code"

decision_rules:
  - id: rule_no_files
    when: "len(source_files) == 0"
    then:
      status: error
      code: NO_SOURCE_FILES
      message: "No source files provided for analysis"

  - id: rule_invalid_layer_config
    when: "len(layer_config.layers) < 2"
    then:
      status: error
      code: INVALID_LAYER_CONFIG
      message: "Layer configuration must define at least 2 layers"

  - id: rule_violations_found_strict
    when: "strict_mode == true and has_violations == true"
    then:
      status: error
      path: report_violations
      action: "Report all violations as errors"

  - id: rule_violations_found
    when: "has_violations == true"
    then:
      status: warning
      path: report_violations
      action: "Report violations as warnings"

  - id: rule_clean
    is_default: true
    when: true
    then:
      status: success
      path: report_clean
      message: "No layer violations detected"

steps:
  - id: parse_layer_config
    action: "Parse and validate layer configuration, build layer hierarchy"
    output: layer_hierarchy

  - id: classify_files
    action: "Classify each source file into its architectural layer based on path patterns"
    output: file_layer_map
    based_on: [layer_hierarchy]

  - id: extract_imports
    action: "Extract import statements and dependencies from each source file"
    output: import_graph

  - id: resolve_imports
    action: "Resolve import paths to actual files and their layers"
    output: resolved_dependencies
    based_on: [import_graph, file_layer_map]

  - id: check_violations
    action: "Compare each dependency against allowed layer dependencies"
    output: violations
    based_on: [resolved_dependencies, layer_hierarchy]

  - id: categorize_violations
    action: "Categorize violations by severity and type"
    output: categorized_violations
    based_on: [violations]

  - id: generate_report
    action: "Generate detailed violation report with fix suggestions"
    output: violation_report
    based_on: [categorized_violations]

output_contract:
  format: json
  schema:
    type: object
    required: [status, analysis]
    properties:
      status:
        type: string
        enum: [clean, violations_found, error]
      analysis:
        type: object
        required: [files_analyzed, layers_detected, violations]
        properties:
          files_analyzed:
            type: integer
          layers_detected:
            type: array
            items:
              type: string
          violations:
            type: array
            items:
              type: object
              required: [source_file, source_layer, target_file, target_layer, violation_type, severity]
              properties:
                source_file:
                  type: string
                  description: "File containing the violating import"
                source_layer:
                  type: string
                  description: "Layer of the source file"
                target_file:
                  type: string
                  description: "File being imported"
                target_layer:
                  type: string
                  description: "Layer of the target file"
                violation_type:
                  type: string
                  enum: [reverse_dependency, skip_layer, forbidden_dependency]
                severity:
                  type: string
                  enum: [error, warning, info]
                line_number:
                  type: integer
                import_statement:
                  type: string
                suggestion:
                  type: string
          summary:
            type: object
            properties:
              total_violations:
                type: integer
              by_type:
                type: object
              by_layer:
                type: object
              most_violated_layer:
                type: string
      metadata:
        type: object
        properties:
          analysis_duration_ms:
            type: integer
          layer_config_hash:
            type: string

failure_modes:
  - code: NO_SOURCE_FILES
    retryable: false
    description: "No source files provided for analysis"

  - code: INVALID_LAYER_CONFIG
    retryable: false
    description: "Layer configuration is invalid or incomplete"

  - code: PARSE_ERROR
    retryable: false
    description: "Failed to parse one or more source files"

  - code: UNCLASSIFIED_FILE
    retryable: false
    description: "Source file does not match any layer pattern"

  - code: ANALYSIS_TIMEOUT
    retryable: true
    description: "Analysis exceeded time limit"

edge_cases:
  - case: empty_source_files
    input:
      source_files: []
      layer_config:
        layers: [{ name: "api", patterns: ["src/api/**"] }]
    expected:
      status: error
      code: NO_SOURCE_FILES

  - case: single_layer_config
    input:
      layer_config:
        layers: [{ name: "api", patterns: ["src/api/**"] }]
    expected:
      status: error
      code: INVALID_LAYER_CONFIG

  - case: file_not_matching_any_layer
    description: "File path does not match any defined layer pattern"
    input:
      source_files:
        - path: "unknown/module.py"
          content: "import api"
      layer_config:
        layers:
          - { name: "api", patterns: ["src/api/**"] }
          - { name: "domain", patterns: ["src/domain/**"] }
    expected:
      status: warning
      analysis:
        violations: []

  - case: valid_downward_dependency
    description: "Higher layer importing from lower layer (allowed)"
    input:
      source_files:
        - path: "src/api/handler.py"
          content: "from domain.user import User"
        - path: "src/domain/user.py"
          content: "class User: pass"
      layer_config:
        layers:
          - { name: "api", patterns: ["src/api/**"] }
          - { name: "domain", patterns: ["src/domain/**"] }
        allowed_dependencies:
          api: ["domain"]
          domain: []
    expected:
      status: clean
      analysis:
        violations: []

  - case: reverse_dependency_detected
    description: "Lower layer importing from higher layer (violation)"
    input:
      source_files:
        - path: "src/domain/user.py"
          content: "from api.handler import process"
        - path: "src/api/handler.py"
          content: "def process(): pass"
      layer_config:
        layers:
          - { name: "api", patterns: ["src/api/**"] }
          - { name: "domain", patterns: ["src/domain/**"] }
        allowed_dependencies:
          api: ["domain"]
          domain: []
    expected:
      status: violations_found
      analysis:
        violations:
          - source_layer: "domain"
            target_layer: "api"
            violation_type: "reverse_dependency"

  - case: skip_layer_violation
    description: "Layer skipping intermediate layer in dependency"
    input:
      source_files:
        - path: "src/api/handler.py"
          content: "from infra.database import connect"
      layer_config:
        layers:
          - { name: "api", patterns: ["src/api/**"] }
          - { name: "domain", patterns: ["src/domain/**"] }
          - { name: "infra", patterns: ["src/infra/**"] }
        allowed_dependencies:
          api: ["domain"]
          domain: ["infra"]
          infra: []
    expected:
      status: violations_found
      analysis:
        violations:
          - violation_type: "skip_layer"

context:
  works_with:
    - skill: "generate-architecture-diagram"
      reason: "Visualize layer structure and violations"
    - skill: "code-review-assistant"
      reason: "Include layer violation checks in PR reviews"
    - skill: "refactor-suggestion"
      reason: "Suggest refactoring to fix violations"

  prerequisites:
    - "Project must have a defined layer architecture"
    - "Source files must use standard import syntax"

  scenarios:
    - name: "CI/CD Pipeline Check"
      trigger: "Pull request opened or updated"
    - name: "Architecture Review"
      trigger: "Periodic architecture health check"
    - name: "Pre-merge Validation"
      trigger: "Before merging feature branch"

examples:
  - name: "Clean Architecture Violation Detection"
    input:
      source_files:
        - path: "src/api/user_controller.py"
          content: |
            from domain.user_service import UserService
            from domain.models import User

            class UserController:
                def __init__(self):
                    self.service = UserService()
          language: "python"
        - path: "src/domain/user_service.py"
          content: |
            from api.auth import get_current_user  # VIOLATION!
            from infra.user_repository import UserRepository

            class UserService:
                def get_user(self, user_id):
                    # Should not depend on API layer
                    current = get_current_user()
                    return self.repo.find(user_id)
          language: "python"
        - path: "src/infra/user_repository.py"
          content: |
            class UserRepository:
                def find(self, user_id):
                    pass
          language: "python"
      layer_config:
        layers:
          - name: "api"
            patterns: ["src/api/**"]
          - name: "domain"
            patterns: ["src/domain/**"]
          - name: "infra"
            patterns: ["src/infra/**"]
        allowed_dependencies:
          api: ["domain"]
          domain: ["infra"]
          infra: []
      strict_mode: false
    output:
      status: violations_found
      analysis:
        files_analyzed: 3
        layers_detected: ["api", "domain", "infra"]
        violations:
          - source_file: "src/domain/user_service.py"
            source_layer: "domain"
            target_file: "src/api/auth.py"
            target_layer: "api"
            violation_type: "reverse_dependency"
            severity: "error"
            line_number: 1
            import_statement: "from api.auth import get_current_user"
            suggestion: "Move authentication logic to domain layer or inject via dependency inversion"
        summary:
          total_violations: 1
          by_type:
            reverse_dependency: 1
          by_layer:
            domain: 1
          most_violated_layer: "domain"
    explanation: "Detects that domain layer is incorrectly importing from api layer, violating Clean Architecture principles"
